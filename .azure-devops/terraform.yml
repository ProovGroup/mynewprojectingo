
steps:
- script: |
    echo "
    machine github.com
    login rnoyon
    password $(git)
    " > ~/.netrc

- task: DownloadSecureFile@1
  name: aws_credentials
  displayName: 'Download AWS Credentials'
  inputs:
    secureFile: 'credentials'
- script: |
    mkdir -p ~/.aws
  displayName: 'New directory to keep the AWS credentials' 
- task: CopyFiles@2
displayName: 'Copy aws credentials to home directory '
inputs:
  SourceFolder: "$(Agent.TempDirectory)"
  contents: 'credentials'
  targetFolder: '~/.aws/'
- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
  displayName: terraform install
  inputs:
    terraformVersion: 'latest'
- task: TerraformTaskV4@4
  displayName: terraform init
  inputs:
    provider : aws
    backendServiceAWS: 'AWS_DEVOPS_TEST'
    backendAWSBucketName: 'weproov-testweproov-shared-tfstates'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/'
    backendAWSKey: 'renaissance.tfstate'
    commandOptions: '-lock=false'
- task: TerraformTaskV4@4
  inputs:
    provider: 'aws'
    command: 'plan'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/'
    environmentServiceNameAWS: 'AWS_DEVOPS_TEST'
    commandOptions: '-lock=false -out main.tfplan'
- task: TerraformTaskV4@4
  inputs:
    provider: 'aws'
    command: 'show'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/'
    outputTo: 'console'
    outputFormat: 'default'
    environmentServiceNameAWS: 'AWS_DEVOPS_TEST'



